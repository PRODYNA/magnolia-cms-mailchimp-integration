#!content-type:audience-csv
#!content-type:campaign
#!content-type:list
appClass: info.magnolia.ui.framework.app.BaseApp
icon: icon-content-app
class: info.magnolia.ui.contentapp.configuration.ContentAppDescriptor
label: app.name

subApps:
  campaigns:
    label: subapp.campaigns.name
    class: info.magnolia.ui.contentapp.configuration.BrowserDescriptor
    subAppClass: info.magnolia.ui.contentapp.ContentBrowserSubApp
    closable: false
    datasource:
      class: info.magnolia.ui.datasource.jcr.JcrDatasourceDefinition
      workspace: mailchimp
      includeProperties: true
      allowedNodeTypes:
        - mlchmp:campaign

    workbench:
      contentViews:
        - name: list
          $type: listView
          columns: !override &columns
            id:
              label: "Campaign ID"
            type:
              label: "Type"
            title:
              label: "Title"
              $type: jsColumn
              modelPath: /mailchimp-connector/backendScripts/valueProviders/childNodeColumn.js
              parameters:
                path: settings
                property: title
            from:
              label: "From"
              $type: jsColumn
              modelPath: /mailchimp-connector/backendScripts/valueProviders/childNodeColumn.js
              parameters:
                path: settings
                property: from_name
            subject_line:
              label: "Subject"
              $type: jsColumn
              modelPath: /mailchimp-connector/backendScripts/valueProviders/childNodeColumn.js
              parameters:
                path: settings
                property: subject_line
            list_id:
              label: "List"
              $type: jsColumn
              modelPath: /mailchimp-connector/backendScripts/valueProviders/childNodeColumn.js
              parameters:
                path: recipients
                property: list_id
            status:
              label: "Mailchimp Campaign Status"
            jcrPublishingStatus:
              $type: jcrStatusColumn
              width: 130

    actionbar:
      sections:
        root:
          availability:
            root: true
          groups:
            importActions:
              name: importActions
              items:
                - name: importCampaigns
            addActions:
              name: addActions
              items:
                - name: addCampaign
                - name: editCampaign
                - name: deleteCampaign
            publicationActions:
              name: publicationActions
              items:
                - name: publishCampaign
            campaignActions:
              name: campaignActions
              items:
                - name: scheduleCampaign

    actions:
      importCampaigns:
        class: info.magnolia.ui.contentapp.action.OpenDetailSubappActionDefinition
        icon: icon-import
        label: Import Campaigns From Mailchimp
        appName: mailchimp
        subAppName: importCampaigns
        viewType: add
        availability:
          root: true
          nodes: false

      addCampaign:
        $type: openDetailSubappAction
        icon: icon-add-item
        label: Add
        appName: mailchimp
        subAppName: campaignDetail
        viewType: add
        availability:
          root: true
          nodes: false

      editCampaign:
        $type: openDetailSubappAction
        icon: icon-edit
        label: Edit
        appName: mailchimp
        subAppName: campaignDetail
        viewType: edit
        availability:
          nodeTypes:
            mailchimp: mlchmp:campaign

      deleteCampaign:
        $type: jsAction
        icon: icon-trash
        modelPath: /mailchimp-connector/backendScripts/actions/deleteNode.js
        label: Delete
        availability:
          nodeTypes:
            mailchimp: mlchmp:campaign
        exposedComponents:
          restClientFactory:
            componentClass: info.magnolia.rest.client.factory.RestClientFactory
            name: restClientFactory
          restClientRegistry:
            componentClass: info.magnolia.rest.client.registry.RestClientRegistry
            name: restClientRegistry
        parameters:
          workspace: mailchimp
          restCall: deleteCampaign
          contentModel: mlchmp:campaign

      publishCampaign:
        $type: jsAction
        icon: icon-publish
        modelPath: /mailchimp-connector/backendScripts/actions/publishNode.js
        label: "Send To Mailchimp"
        availability:
          nodeTypes:
            mailchimp: mlchmp:campaign
          rules:
            isPublishable: &isPublishable
              $type: jcrPublishableRule
        exposedComponents:
          restClientFactory:
            componentClass: info.magnolia.rest.client.factory.RestClientFactory
            name: restClientFactory
          restClientRegistry:
            componentClass: info.magnolia.rest.client.registry.RestClientRegistry
            name: restClientRegistry
        parameters:
          workspace: mailchimp
          restCallSuffix: Campaign

      scheduleCampaign:
        $type: openDetailSubappAction
        icon: icon-mail-setting
        label: Schedule Campaign
        appName: mailchimp
        subAppName: scheduleCampaignDetail
        viewType: edit
        availability:
          nodeTypes:
            mailchimp: mlchmp:campaign

  lists:
    label: Lists
    class: info.magnolia.ui.contentapp.configuration.BrowserDescriptor
    subAppClass: info.magnolia.ui.contentapp.ContentBrowserSubApp
    closable: false
    datasource:
      class: info.magnolia.ui.datasource.jcr.JcrDatasourceDefinition
      workspace: mailchimp
      includeProperties: true
      allowedNodeTypes:
        - mlchmp:list

    workbench:
      contentViews:
        - name: list
          $type: listView
          columns: !override &columns
            id:
              label: ID
            name:
              label: List Name
            members:
              label: Members
            jcrPublishingStatus:
              $type: jcrStatusColumn
              width: 130
    actionbar:
      sections:
        root:
          availability:
            root: true
          groups:
            importActions:
              name: importActions
              items:
                - name: importLists
            addActions:
              name: addActions
              items:
                - name: addList
                - name: editList
                - name: deleteList
            publicationActions:
              name: publicationActions
              items:
                - name: publishList
            listActions:
              name: listActions
              items:
                - name: importAudience

    actions:
      importLists:
        class: info.magnolia.ui.contentapp.action.OpenDetailSubappActionDefinition
        label: Import Lists from Mailchimp
        icon: icon-import
        appName: mailchimp
        subAppName: importLists
        viewType: add
        availability:
          root: true
          nodes: false
      importAudience:
        $type: openDetailSubappAction
        label: Import Audience
        appName: mailchimp
        subAppName: importAudience
        viewType: edit
        icon: icon-mail-setting
        availability:
          root: true
          nodes: false
      addList:
        $type: openDetailSubappAction
        label: "Add"
        icon: icon-add-item
        appName: mailchimp
        subAppName: listDetail
        viewType: add
        availability:
          root: true
          nodes: false
      editList:
        $type: openDetailSubappAction
        label: "Edit"
        icon: icon-edit
        appName: mailchimp
        subAppName: listDetail
        viewType: edit
        availability:
          nodeTypes:
            mailchimp: mlchmp:list
      deleteList:
        $type: jsAction
        modelPath: /mailchimp-connector/backendScripts/actions/deleteNode.js
        label: "Delete"
        icon: icon-trash
        availability:
          nodeTypes:
            mailchimp: mlchmp:list
        exposedComponents:
          restClientFactory:
            componentClass: info.magnolia.rest.client.factory.RestClientFactory
            name: restClientFactory
          restClientRegistry:
            componentClass: info.magnolia.rest.client.registry.RestClientRegistry
            name: restClientRegistry
        parameters:
          workspace: mailchimp
          restCall: deleteList
          contentModel: mlchmp:list
      publishList:
        $type: jsAction
        icon: icon-publish
        modelPath: /mailchimp-connector/backendScripts/actions/publishNode.js
        label: "Send To Mailchimp"
        availability:
          nodeTypes:
            mailchimp: mlchmp:list
          rules:
            isPublishable: &isPublishable
              $type: jcrPublishableRule
        exposedComponents:
          restClientFactory:
            componentClass: info.magnolia.rest.client.factory.RestClientFactory
            name: restClientFactory
          restClientRegistry:
            componentClass: info.magnolia.rest.client.registry.RestClientRegistry
            name: restClientRegistry
        parameters:
          workspace: mailchimp
          restCallSuffix: List

  importAudience:
    label: Import Audience
    class: info.magnolia.ui.contentapp.configuration.BrowserDescriptor
    closable: true
    datasource:
      class: info.magnolia.ui.datasource.jcr.JcrDatasourceDefinition
      workspace: mailchimp
      includeProperties: true
      allowedNodeTypes:
        - mlchmp:audience-csv
    workbench:
      contentViews:
        - name: list
          $type: listView
          columns:
            - name: jcrName
              label: Name
            - name: list
              label: List Id
            - name: csvDoc
              label: CSV File Name
              $type: jsColumn
              modelPath: /mailchimp-connector/backendScripts/valueProviders/csvColumn.js
            - name: status
              label: Status
    actionbar:
      sections:
        root:
          groups:
            main:
              items:
                - name: linkFileToList
          availability:
            root: true
            nodes: false
        node:
          groups:
            main:
              label: Execute
              items:
                - name: batchSubscribe
          availability:
            root: false
            nodes: true
            nodeTypes:
              - mlchmp:audience-csv

    actions:
      linkFileToList:
        $type: openDetailSubappAction
        label: Create Import Audience Job (CSV)
        appName: mailchimp
        subAppName: linkFileToListSubApp
        icon: icon-add-item
        viewType: add
        populate: false
        availability:
          nodes: false
          root: true
      batchSubscribe:
        $type: jsAction
        modelPath: /mailchimp-connector/backendScripts/actions/batchSubscribe.js
        label: Execute Batch Subscribe
        icon: icon-mail-setting
        availability:
          root: false
          nodeTypes:
            csvList: mlchmp:audience-csv

  linkFileToListSubApp:
    label: Create Import Audience Job
    class: info.magnolia.ui.contentapp.detail.DetailDescriptor
    closable: true
    datasource:
      class: info.magnolia.ui.datasource.jcr.JcrDatasourceDefinition
      workspace: mailchimp
      includeProperties: true
      allowedNodeTypes:
        - mlchmp:audience-csv

    actions:
      commit:
        $type: commitAction
      cancel:
        $type: closeAction
    itemProvider:
      $type: jcrNodeFromLocationProvider
      nodeType: mlchmp:audience-csv
    form:
      properties:
        jcrName:
          $type: textField
          required: true
        list:
          label: List
          $type: jsonComboBoxField
          required: true
          datasource:
            name: rest
            $type: jsonDatasource
            restClient: mailchimpRestClient
            restCall: getLists
            jsonPathExpressions:
              itemId: '$.id'
              items: "$.lists[*]"
              describeBy: '$.name'
              properties:

        csvDoc:
          $type: damLinkField
          label: CSV Document
          required: true
          placeholder: Subscribers File Placeholder
          buttonSelectNewLabel: New
          textInputAllowed: true

  importCampaigns:
    class: info.magnolia.ui.contentapp.detail.DetailDescriptor
    itemProvider:
      $type: jcrNodeFromLocationProvider
    datasource:
      $type: jcrDatasource
      workspace: mailchimp
      allowedNodeTypes:
        - mlchmp:campaign
    actions:
      cancel:
        label: Cancel
        class: info.magnolia.ui.contentapp.action.CloseActionDefinition
      commit:
        $type: jsAction
        modelPath: /mailchimp-connector/backendScripts/actions/importNodes.js
        label: Custom Sub App
        exposedComponents:
          restClientFactory:
            componentClass: info.magnolia.rest.client.factory.RestClientFactory
            name: restClientFactory
          restClientRegistry:
            componentClass: info.magnolia.rest.client.registry.RestClientRegistry
            name: restClientRegistry
        parameters:
          workspace: mailchimp
          restCall: getCampaigns
          bodyProperty: campaigns
          contentModel: mlchmp:campaign
    #      save:
    #        label: Save
    #        class: info.magnolia.ui.contentapp.action.CommitActionDefinition
    form:
      properties:
        id:
          $type: listSelectField
          # --- REST CALL TO THE ../restClients/mailchimpClient.yaml - restCall: getLists
          datasource:
            $type: jsonDatasource
            restClient: mailchimpRestClient
            restCall: getCampaigns
            jsonPathExpressions:
              itemId: '$.id'
              items: "$.campaigns[*]"
              describeBy: '$.settings.subject_line'

  importLists:
    icon: icon-import
    class: info.magnolia.ui.contentapp.detail.DetailDescriptor
    itemProvider:
      $type: jcrNodeFromLocationProvider
    datasource:
      $type: jcrDatasource
      workspace: mailchimp
      allowedNodeTypes:
        - mlchmp:list
    actions:
      cancel:
        label: Cancel
        class: info.magnolia.ui.contentapp.action.CloseActionDefinition
      commit:
        $type: jsAction
        modelPath: /mailchimp-connector/backendScripts/actions/importNodes.js
        label: Custom Sub App
        exposedComponents:
          restClientFactory:
            componentClass: info.magnolia.rest.client.factory.RestClientFactory
            name: restClientFactory
          restClientRegistry:
            componentClass: info.magnolia.rest.client.registry.RestClientRegistry
            name: restClientRegistry
        parameters:
          workspace: mailchimp
          restCall: getLists
          bodyProperty: lists
          contentModel: mlchmp:list
    form:
      properties:
        id:
          $type: listSelectField
          # --- REST CALL TO THE ../restClients/mailchimpClient.yaml - restCall: getLists
          datasource:
            $type: jsonDatasource
            restClient: mailchimpRestClient
            restCall: getLists
            jsonPathExpressions:
              itemId: '$.id'
              items: "$.lists[*]"
              describeBy: '$.name'

  listDetail:
    label: "Add/Edit List"
    class: info.magnolia.ui.contentapp.detail.DetailDescriptor
    closeable: true
    datasource:
      $type: jcrDatasource
      workspace: mailchimp
      allowedNodeTypes:
        - mlchmp:list
    itemProvider:
      $type: jcrNodeFromLocationProvider
      workspace: mailchimp
      nodeType: mlchmp:list
    form:
      properties:
        name:
          label: "Name"
          $type: textField
          required: true
        email_type_option:
          label: "User Email Format Option"
          description: "When set to allow, subscribers can choose whether they want to receive HTML or plain-text emails. When set to not allowed, subscribers will receive HTML emails, with a plain-text alternative backup."
          $type: comboBoxField
          required: true
          datasource:
            $type: optionListDatasource
            options:
              plaintext:
                value: true
                label: "Allow User Selection"
              regular:
                value: false
                label: "Disallow User Selection"
        members:
          label: "Contact(s)"
          $type: textField
          readOnly: true
          defaultValue: "0"
        permission_reminder:
          label: "Permission Reminder"
          description: "A permission reminder is a text embedded in your email campaigns that makes it clear where your recipients signed up to receive email marketing messages"
          $type: textField
          rows: 3
          required: true
        contact:
          label: "Contact Information"
          $type: compositeField
          itemProvider:
            $type: jcrChildNodeProvider
          properties:
            company:
              label: "Company Name"
              description: "The company name for the list."
              $type: textField
              required: true
            address1:
              label: "Street Address"
              description: "The street address for the list contact."
              $type: textField
              required: true
            city:
              label: "City"
              description: "The city for the list contact."
              $type: textField
              required: true
            zip:
              label: "Zip"
              description: "The postal or zip code for the list contact."
              $type: textField
              required: true
            state:
              label: "State"
              description: "The state for the list contact."
              $type: textField
              required: true
            country:
              label: "The country."
              $type: textField
              readOnly: true
              defaultValue: "US"
        campaign_defaults:
          label: "Campaign Default Values"
          $type: compositeField
          itemProvider:
            $type: jcrChildNodeProvider
          properties:
            from_name:
              label: "From Name"
              description: "The default from name for campaigns sent to this list."
              $type: textField
              required: true
            from_email:
              label: "From Email"
              description: "The default from email for campaigns sent to this list."
              $type: textField
              required: true
              validators:
                from_email:
                  $type: emailValidator
                  errorMessage: "Invalid Email Address"
            subject:
              label: "Subject"
              description: "The default subject line for campaigns sent to this list."
              $type: textField
              required: true
            language:
              label: "Language"
              description: "The default language for this lists's forms."
              $type: textField
              required: true

  campaignDetail:
    label: Add/Edit Campaign
    class: info.magnolia.ui.contentapp.detail.DetailDescriptor
    datasource:
      $type: jcrDatasource
      workspace: mailchimp
      allowedNodeTypes:
        - mlchmp:campaign
    itemProvider:
      $type: jcrNodeFromLocationProvider
      workspace: mailchimpCampaign
      nodeType: mlchmp:campaign
    form:
      properties:
        type:
          label: Type
          $type: comboBoxField
          required: true
          datasource:
            $type: optionListDatasource
            options:
              plaintext:
                value: plaintext
                label: PLAINTEXT
              regular:
                value: regular
                label: REGULAR

        recipients:
          label: Recipients
          $type: compositeField
          itemProvider:
            $type: jcrChildNodeProvider
          properties:
            list_id:
              label: List
              $type: restComboBoxField
              required: true
              datasource:
                name: rest
                $type: jsonDatasource
                restClient: mailchimpRestClient
                restCall: getLists
                jsonPathExpressions:
                  itemId: '$.id'
                  items: '$.lists'
                  describeBy: '$.name'

        settings:
          label: Recipients
          $type: compositeField
          itemProvider:
            $type: jcrChildNodeProvider
          properties:


            to_name:
              label: To
              $type: textField
              required: true
            from_name:
              label: from
              $type: textField
              required: true
            subject_line:
              label: Subject
              $type: textField
              required: true
            title:
              label: Title
              $type: textField
              required: true
    actions:
      cancel:
        label: Cancel
        $type: closeAction
      commit:
        $type: commitAction
        label: Save Changes

  scheduleCampaignDetail:
    label: Schedule Campaign
    class: info.magnolia.ui.contentapp.detail.DetailDescriptor
    datasource:
      $type: jcrDatasource
      workspace: mailchimp
      allowedNodeTypes:
        - mlchmp:campaign
    itemProvider:
      $type: jcrNodeFromLocationProvider
    form:
      properties:
        id:
          label: "Campaign"
          $type: restComboBoxField
          datasource:
            name: rest
            $type: jsonDatasource
            restClient: mailchimpRestClient
            restCall: getCampaigns
            jsonPathExpressions:
              itemId: '$.id'
              items: '$.campaigns'
              describeBy: '$.settings.title'
        schedule_time:
          label: "Schedule Date"
          $type: dateField
          dateFormat: "yyyy-MM-dd"
          time: true
          timeFormat: "HH:mm:ss"
    actions:
      cancel:
        label: Cancel
        class: info.magnolia.ui.contentapp.action.CloseActionDefinition
      commit:
        $type: jsAction
        modelPath: /mailchimp-connector/backendScripts/actions/scheduleMailchimpCampaignAction.js
        label: Schedule