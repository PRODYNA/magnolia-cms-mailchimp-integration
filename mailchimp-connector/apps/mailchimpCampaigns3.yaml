appClass: info.magnolia.ui.framework.app.BaseApp
icon: icon-content-app
class: info.magnolia.ui.contentapp.configuration.ContentAppDescriptor
label: Mailchimp Campaigns 3

subApps:
  campaigns:
    label: Mailchimp Campaigns
    class: info.magnolia.ui.contentapp.configuration.BrowserDescriptor
    subAppClass: info.magnolia.ui.contentapp.ContentBrowserSubApp
    closable: false
    datasource:
      class: info.magnolia.ui.datasource.jcr.JcrDatasourceDefinition
      workspace: mailchimpCampaign
      includeProperties: true
      allowedNodeTypes:
        - sch:mailchimpCampaign

    workbench:
      contentViews:

        - name: list
          $type: listView
          columns: !override &columns
            id:
              label: ID
            type:
              label: type
            title:
              label: Title
              $type: jsColumn
              modelPath: /mailchimp-connector/backendScripts/valueProviders/childNodeColumn.js
              parameters:
                path: settings
                property: title
            subject_line:
              label: Subject
              $type: jsColumn
              modelPath: /mailchimp-connector/backendScripts/valueProviders/childNodeColumn.js
              parameters:
                path: settings
                property: subject_line
            from_name:
              label: From Name
              $type: jsColumn
              modelPath: /mailchimp-connector/backendScripts/valueProviders/childNodeColumn.js
              parameters:
                path: settings
                property: from_name
            to_name:
              label: To name
              $type: jsColumn
              modelPath: /mailchimp-connector/backendScripts/valueProviders/childNodeColumn.js
              parameters:
                path: settings
                property: to_name
            list_id:
              label: List
              $type: jsColumn
              modelPath: /mailchimp-connector/backendScripts/valueProviders/childNodeColumn.js
              parameters:
                path: recipients
                property: list_id
            status:
              label: Status
        - name: tree
          $type: treeView
          columns: *columns
    actionbar:
      sections:
        root:
          availability:
            root: true
          groups:
            addActions:
              name: addActions
              items:
                - name: addCampaign
                - name: importCampaigns
            editAction:
              name: editActions
              items:
                - name: editCampaign
                - name: newScheduleCampaign
                - name: publishCampaign
                - name: deleteCampaign
    actions:
      importCampaigns:
        class: info.magnolia.ui.contentapp.action.OpenDetailSubappActionDefinition
        label: Import Campaigns
        appName: mailchimpCampaigns3
        subAppName: details
        viewType: add
        availability:
          root: true
          nodes: false
          writePermissionRequired: true

      addCampaign:
        $type: openDetailSubappAction
        label: Add campaign
        appName: mailchimpCampaigns3
        subAppName: campaignDetail
        viewType: add
        availability:
          root: true
          nodes: false
      editCampaign:
        $type: openDetailSubappAction
        label: Edit Campaign
        appName: mailchimpCampaigns3
        subAppName: campaignDetail
        viewType: edit
        availability:
          nodeTypes:
            mailchimpCampaign: sch:mailchimpCampaign

      publishCampaign:
        $type: jsAction
        modelPath: /mailchimp-connector/backendScripts/actions/publishMailchimpCampaignAction.js
        label: Sync to Campaign Campaign
        availability:
          nodeTypes:
            mailchimpCampaign: sch:mailchimpCampaign
        exposedComponents:
          restClientFactory:
            componentClass: info.magnolia.rest.client.factory.RestClientFactory
            name: restClientFactory
          restClientRegistry:
            componentClass: info.magnolia.rest.client.registry.RestClientRegistry
            name: restClientRegistry
        parameters:
          workspace: mailchimpCampaign
          restCall: addCampaign
          contentModel: sch:mailchimpCampaign
      deleteCampaign:
        $type: jsAction
        modelPath: /mailchimp-connector/backendScripts/actions/deleteMailchimpCampaignAction.js
        label: Delete Campaign
        availability:
          nodeTypes:
            mailchimpCampaign: sch:mailchimpCampaign
        exposedComponents:
          restClientFactory:
            componentClass: info.magnolia.rest.client.factory.RestClientFactory
            name: restClientFactory
          restClientRegistry:
            componentClass: info.magnolia.rest.client.registry.RestClientRegistry
            name: restClientRegistry
        parameters:
          workspace: mailchimpCampaign
          restCall: deleteCampaign
          contentModel: sch:mailchimpCampaign

      newScheduleCampaign:
        $type: openDetailSubappAction
        label: Schedule Campaign
        appName: mailchimpCampaigns3
        subAppName: scheduleCampaignDetail
        viewType: edit
        availability:
          nodeTypes:
            mailchimpCampaign: sch:mailchimpCampaign

      addMailchimpCampaignAction:
        $type: jsAction
        modelPath: /mailchimp-connector/templates/js/addMailchimpCampaignAction.js
        label: Create Mailchimp Campaign

  schedule-campaigns:
    label: Schedule Mailchimp campaign
    class: info.magnolia.ui.contentapp.configuration.BrowserDescriptor
    subAppClass: info.magnolia.ui.contentapp.ContentBrowserSubApp
    closable: false
    datasource:
      class: info.magnolia.ui.datasource.jcr.JcrDatasourceDefinition
      workspace: scheduleCampaign
      includeProperties: true
      allowedNodeTypes:
        - sch:scheduleCampaign

    workbench:
      contentViews:
        - name: list
          $type: listView
          columns:
            - name: id
              label: Campaign ID
            - name: schedule_time
              label: Schedule Time

    actionbar:
      sections:
        root:
          availability:
            root: true
          groups:
            addActions:
              name: addActions
              items:
                - name: newScheduleCampaign
            editActions:
              name: editActions
              items:
                - name: editScheduleCampaign
                - name: scheduleMailchimpCampaignAction
    actions:
      newScheduleCampaign:
        $type: openDetailSubappAction
        label: Add Schedule Campaign
        appName: mailchimpCampaigns3
        subAppName: scheduleCampaignDetail
        viewType: add
        availability:
          root: true
      editScheduleCampaign:
        $type: openDetailSubappAction
        label: Edit Schedule Campaign
        appName: mailchimpCampaigns3
        subAppName: scheduleCampaignDetail
        viewType: edit
        availability:
          nodeTypes:
            mailchimpCampaign: sch:scheduleCampaign
      scheduleMailchimpCampaignAction:
        $type: jsAction
        modelPath: /mailchimp-connector/templates/js/scheduleMailchimpCampaignAction.js
        label: Schedule Campaign
        icon: icon-mail-setting

  campaignDetail:
    label: Add/Edit Campaign
    class: info.magnolia.ui.contentapp.detail.DetailDescriptor
    datasource:
      $type: jcrDatasource
      workspace: mailchimpCampaign
      allowedNodeTypes:
        - sch:mailchimpCampaign
    itemProvider:
      $type: jcrNodeFromLocationProvider
      workspace: mailchimpCampaign
      nodeType: sch:mailchimpCampaign
    form:
      properties:
        type:
          label: Type
          $type: comboBoxField
          required: true
          datasource:
            $type: optionListDatasource
            options:
              plaintext:
                value: plaintext
                label: PLAINTEXT
              regular:
                value: regular
                label: REGULAR

        recipients:
          label: Recipients
          $type: compositeField
          itemProvider:
            $type: jcrChildNodeProvider
          properties:
            list_id:
              label: List
              $type: restComboBoxField
              required: true
              datasource:
                name: rest
                $type: jsonDatasource
                restClient: mailchimpRestClient
                restCall: getLists
                jsonPathExpressions:
                  itemId: '$.id'
                  items: '$.lists'
                  describeBy: '$.name'

        settings:
          label: Recipients
          $type: compositeField
          itemProvider:
            $type: jcrChildNodeProvider
          properties:


            to_name:
              label: To
              $type: textField
              required: true
            from_name:
              label: from
              $type: textField
              required: true
            subject_line:
              label: Subject
              $type: textField
              required: true
            title:
              label: Title
              $type: textField
              required: true
    actions:
      cancel:
        label: Cancel
        $type: closeAction
      commit:
        $type: commitAction
        label: Save Changes

  scheduleCampaignDetail:
    label: Schedule Campaign
    class: info.magnolia.ui.contentapp.detail.DetailDescriptor
    datasource:
      $type: jcrDatasource
      workspace: mailchimpCampaign
      allowedNodeTypes:
        - sch:mailchimpCampaign
    itemProvider:
      $type: jcrNodeFromLocationProvider
    form:
      properties:
        id:
          label: Campaign
          $type: restComboBoxField
          datasource:
            name: rest
            $type: jsonDatasource
            restClient: mailchimpRestClient
            restCall: getCampaigns
            jsonPathExpressions:
              itemId: '$.id'
              items: '$.campaigns'
              describeBy: '$.settings.title'
        schedule_time:
          $type: dateField
          dateFormat: "yyyy-MM-dd"
          time: true
          timeFormat: "HH:mm:ss"
    actions:
      cancel:
        label: Cancel
        class: info.magnolia.ui.contentapp.action.CloseActionDefinition
      commit:
        $type: jsAction
        modelPath: /mailchimp-connector/templates/js/scheduleMailchimpCampaignAction.js
        label: Schedule


  details:
    class: info.magnolia.ui.contentapp.detail.DetailDescriptor
    itemProvider:
      $type: jcrNodeFromLocationProvider
    datasource:
      $type: jcrDatasource
      workspace: mailchimpCampaign
      allowedNodeTypes:
        - sch:mailchimpCampaign
    actions:
      cancel:
        label: Cancel
        class: info.magnolia.ui.contentapp.action.CloseActionDefinition
      commit:
        $type: jsAction
        modelPath: /mailchimp-connector/backendScripts/actions/importNodes.js
        label: Custom Sub App
        exposedComponents:
          restClientFactory:
            componentClass: info.magnolia.rest.client.factory.RestClientFactory
            name: restClientFactory
          restClientRegistry:
            componentClass: info.magnolia.rest.client.registry.RestClientRegistry
            name: restClientRegistry
        parameters:
          workspace: mailchimpCampaign
          restCall: getCampaigns
          bodyProperty: campaigns
          contentModel: sch:mailchimpCampaign
    form:
      properties:
        id:
          $type: listSelectField
          # --- REST CALL TO THE ../restClients/listRestClient.yaml - restCall: getCampaigns
          datasource:
            $type: jsonDatasource
            restClient: mailchimpRestClient
            restCall: getCampaigns
            jsonPathExpressions:
              itemId: '$.id'
              items: "$.campaigns[*]"
              describeBy: '$.settings.subject_line'

